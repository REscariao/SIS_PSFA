<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Gest√£o de Convites - Sistema Paroquial</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>

    <header class="navbar">
        <div class="nav-container">
            <a href="index.html" class="logo">‚õ™ Minha<span>Par√≥quia</span></a>
            <nav>
                <ul class="nav-links">
                    <li><a href="index.html">In√≠cio</a></li>
                    <li><a href="secretaria.html">Secretaria</a></li>
                    <li><a href="equipes.html" class="active">Equipes</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="content">
        <div class="form-card full-width">
             <header class="form-header header-flex" style="display: flex; justify-content: space-between; align-items: flex-end; flex-wrap: wrap; gap: 20px;">
                <div style="display: flex; align-items: flex-end; gap: 15px; flex-wrap: wrap;">
                    <div>
                        <h2>Gest√£o de Convites & Escalas</h2>
                        <p>Filtre por encontro para gerenciar os casais e imprimir as convoca√ß√µes.</p>
                        <div style="display: flex; align-items: center; gap: 15px; margin-top: 15px;">
                            <select id="filtro_encontro" class="form-select" style="width: 350px; margin-top: 0;">
                                <option value="">Selecione o Encontro...</option>
                            </select>
                            
                            <a href="montar_equipe.html" class="btn btn-primary" style="min-width: 200px;">
                                <i class="fas fa-plus"></i> Escalar Novo Casal
                            </a>
                        </div>
                    </div>
                </div>
            </header>

            <hr class="form-divider">

            <div id="lista-equipes-convites">
                <div style="text-align:center; padding: 80px 20px;">
                    <div style="font-size: 3rem; margin-bottom: 20px;">üìã</div>
                    <h3 style="color: #666;">Aguardando Sele√ß√£o</h3>
                    <p style="color: #999;">Escolha um encontro acima para carregar as equipes e casais escalados.</p>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <p>&copy; 2026 - Gest√£o Paroquial Inteligente - Patos-PB</p>
    </footer>

    <script>
        async function carregarEncontros() {
            try {
                const res = await fetch('api/listar_encontros_api.php');
                const encontros = await res.json();
                const select = document.getElementById('filtro_encontro');
                
                encontros.forEach(e => {
                    const option = document.createElement('option');
                    option.value = e.id;
                    option.textContent = `${e.nome_encontro} - ${e.periodo}`;
                    select.appendChild(option);
                });
            } catch (error) { console.error("Erro encontros:", error); }
        }

        async function carregarConvites(idEncontro) {
            const container = document.getElementById('lista-equipes-convites');

            if(!idEncontro) return;
            
            container.innerHTML = '<p style="text-align:center; padding: 40px;">Buscando escalas...</p>';

            try {
                const res = await fetch(`api/listar_convites_evento.php?encontro=${idEncontro}`);
                const dados = await res.json();
                container.innerHTML = '';

                if (dados.length === 0) {
                    container.innerHTML = '<div style="text-align:center; padding: 60px;"><p>Nenhum casal escalado ainda para este encontro.</p></div>';
                    return;
                }

                const equipes = {};
                dados.forEach(item => {
                    if (!equipes[item.nome_equipe]) equipes[item.nome_equipe] = [];
                    equipes[item.nome_equipe].push(item);
                });

                for (const nomeEquipe in equipes) {
                    let html = `
                    <div class="equipe-card">
                        <div class="equipe-header">
                            <div style="display:flex; align-items:center; gap:15px;">
                                <h3>${nomeEquipe}</h3>
                                <span class="count">${equipes[nomeEquipe].length} Casais</span>
                            </div>
                            <a href="api/gerar_convite_oficial.php?encontro=${idEncontro}&equipe=${encodeURIComponent(nomeEquipe)}" 
                               target="_blank" class="btn-print-sm">üñ®Ô∏è Imprimir Convites da Equipe</a>
                        </div>
                        <table class="modern-table">
                            <thead>
                                <tr>
                                    <th>Casal</th>
                                    <th>Fun√ß√£o na Equipe</th>
                                    <th style="text-align:right;">Status do Convite</th>
                                </tr>
                            </thead>
                            <tbody>`;

                    equipes[nomeEquipe].forEach(c => {
                        let statusClass = c.status === 'Aceito' ? 'badge-success' : 'badge-warning';
                        html += `
                            <tr>
                                <td class="casal-info">
                                    <strong>${c.ele_nome} & ${c.ela_nome}</strong>
                                    <small>(${c.ele_apelido} & ${c.ela_apelido})</small>
                                </td>
                                <td style="font-weight: 500; color: #555;">${c.funcao}</td>
                                <td style="text-align:right;"><span class="badge ${statusClass}">${c.status || 'Pendente'}</span></td>
                            </tr>`;
                    });

                    html += `</tbody></table></div>`;
                    container.innerHTML += html;
                }
            } catch (error) {
                container.innerHTML = '<p style="text-align:center; color:red; padding:40px;">Erro de conex√£o com a API.</p>';
            }
        }

        document.getElementById('filtro_encontro').addEventListener('change', (e) => carregarConvites(e.target.value));
        carregarEncontros();
    </script>
</body>
</html>